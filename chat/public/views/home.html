<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      .text-custom {
        background-color: #cccccc;
      }
    </style>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />

    <title>chat</title>
  </head>
  <body>
    <div
      class="success-message alert alert-success"
      id="msg_send"
      style="display: none"
    ></div>
    <div
      class="success-message alert alert-success"
      id="msg_send"
      style="display: none"
    ></div>
    <div class="container">
      <div class="card">
        <div class="card-body" id="chat-container">
          <h5 class="card-title text-center">Chat App</h5>
          <!-- <p class="card-text text-custom pt2 pb-2 ps-1">Hello User 1</p>
          <p class="card-text pt2 pb-2 ps-1">Hello User 2</p>
          <p class="card-text text-custom pt2 pb-2 ps-1">How are you user 1?</p>
          <p class="card-text pt2 pb-2 ps-1">am good user 1</p>
          <p class="card-text text-custom pt2 pb-2 ps-1">what's up ?</p>
          <p class="card-text pt2 pb-2 ps-1">nothing</p> -->
        </div>
      </div>
    </div>
    <div class="container bg-info fixed-bottom">
      <div class="card bg-info">
        <form method="post">
          <div class="card-body">
            <div class="mb-3">
              <label for="info">Please enter your message</label>
              <input type="text" class="form-control" id="message" />
              <input
                type="hidden"
                name="reciever_id"
                id="reciever_id"
                value="5"
              />
            </div>
            <button type="submit" class="btn btn-dark" id="msg">Submit</button>
          </div>
        </form>
      </div>
    </div>
    <script
      src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"
      type="text/javascript"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
      integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        axios
          .get(
            "http://localhost:3000/chat/get",

            {
              withCredentials: true,
            }
          )
          .then((response) => {
            const messages = response.data["message"];
            const data = response.data["data"];
            const suc = response.data["success"];

            if (suc == true) {
              document.getElementById("msg_send").innerHTML = messages;

              jQuery("#msg_send").show(0).delay(5000).hide(0);
            } else {
              document.getElementById("msg_send").innerHTML = messages;
              jQuery("#msg_send").show(0).delay(5000).hide(0);
            }
            data.forEach(chatrendering);
          })
          .catch((err) => {
            console.log(err);
          });
      });
      const res = document.getElementById("msg");
      res.addEventListener("click", function (e) {
        e.preventDefault();

        const message = document.getElementById("message").value;
        const reciever_id = document.getElementById("reciever_id").value;

        axios
          .post(
            "http://localhost:3000/chat/send",
            {
              message: message,
              reciever_id: reciever_id,
            },
            {
              withCredentials: true,
            }
          )
          .then((response) => {
            const messages = response.data["message"];
            const suc = response.data["success"];
            if (suc == true) {
              document.getElementById("msg_send").innerHTML = messages;

              jQuery("#msg_send").show(0).delay(1000).hide(0);
              setTimeout(() => {
                location.reload();
              }, 1000);
            } else {
              document.getElementById("msg_send").innerHTML = messages;
              jQuery("#msg_send").show(0).delay(5000).hide(0);
            }
          })
          .catch((err) => {
            console.log(err);
          });
      });

      function chatrendering(item) {
        console.log(item);
        const chat_container = document.getElementById("chat-container");
        const para = document.createElement("p");
        if (item.userId == item.user.id) {
          para.className = "card-text text-custom pt2 pb-2 ps-1";
        } else {
          para.className = "card-text pt2 pb-2 ps-1";
        }
        para.innerText = item.message;

        chat_container.append(para);
      }
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
